<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Opptym - Smart Form Automation</title>
    
    <!-- COMPREHENSIVE AUTHENTICATION CLEANUP -->
    <script>
      (function() {
        console.log('üöÄ Opptym: Starting comprehensive authentication cleanup...');
        
        // FORCE CLEAR ALL AUTHENTICATION DATA
        function forceClearAuth() {
          console.log('üßπ Force clearing all authentication data...');
          
          // Clear all storage
          localStorage.clear();
          sessionStorage.clear();
          
          // Clear specific items
          localStorage.removeItem('token');
          localStorage.removeItem('user');
          localStorage.removeItem('activeTab');
          
          // Clear cookies
          document.cookie.split(";").forEach(function(c) { 
            document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
          });
          
          console.log('‚úÖ All authentication data cleared');
        }
        
        // Check if we need to force clear
        const token = localStorage.getItem('token');
        if (token) {
          try {
            // Basic validation
            const parts = token.split('.');
            if (parts.length !== 3) {
              console.log('‚ùå Invalid token structure - forcing clear');
              forceClearAuth();
              return;
            }
            
            // Try to decode
            const payload = JSON.parse(atob(parts[1]));
            if (!payload.userId || !payload.email) {
              console.log('‚ùå Invalid token payload - forcing clear');
              forceClearAuth();
              return;
            }
            
            // Check expiration
            if (payload.exp && payload.exp * 1000 < Date.now()) {
              console.log('‚ùå Token expired - forcing clear');
              forceClearAuth();
              return;
            }
            
            console.log('‚úÖ Token appears valid');
          } catch (error) {
            console.log('‚ùå Token validation failed - forcing clear');
            forceClearAuth();
          }
        }
        
        // Add global functions for debugging
        window.forceLogout = function() {
          console.log('üîç Force logout triggered');
          forceClearAuth();
          window.location.href = '/';
        };
        
        window.clearAllData = function() {
          console.log('üîç Clear all data triggered');
          forceClearAuth();
          window.location.reload();
        };
        
        window.checkAuth = function() {
          const token = localStorage.getItem('token');
          console.log('üîç Current token:', token ? 'EXISTS' : 'NONE');
          if (token) {
            try {
              const parts = token.split('.');
              const payload = JSON.parse(atob(parts[1]));
              console.log('üîç Token payload:', payload);
            } catch (e) {
              console.log('üîç Token decode error:', e);
            }
          }
        };
        
        console.log('üîß Debug functions available:');
        console.log('  - window.forceLogout() - Force logout and redirect');
        console.log('  - window.clearAllData() - Clear all data and reload');
        console.log('  - window.checkAuth() - Check current auth status');
        
        // Auto-clear on any 401 error
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
          return originalFetch.apply(this, args).then(response => {
            if (response.status === 401) {
              console.log('üîç 401 detected in fetch - forcing logout');
              forceClearAuth();
              window.location.href = '/';
            }
            return response;
          });
        };
        
        console.log('üöÄ Authentication cleanup complete');
      })();
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
